#!/usr/bin/python

import subprocess

welcome_page = """
<html>
<head>
<style>
html, body { width: 100%; height: 100%; position: relative; }
.myButton {
    border: none;
    border-radius: 2px;
    padding: 0 10px;
    text-decoration: none;
    color: #fff;
    font-size: 1.1em;
    background-color: #6C7A89;
    display: inline-block;
    margin-top: 10px;
    height: 50px;
    line-height: 50px;
    text-align: center;
    cursor: pointer;
}
.myButton:hover {
    background-color: #95A5A6;
    color: #fff;
}
.myButton:active {
    position:relative;
    top:1px;
}
.center {
position: absolute; top: calc(50% - 60px);left: calc(50% - 260px);
width: 500px; height: 100px; border: 0px; padding: 10px;
text-align:center;
}
</style>
</head>
<body>
<div class="center">
<h3>You will now be redirected to {{ fqdn }}</h3>
<a href="/letmein.html" class="myButton">Ok</a>
</div>
</body>
</html>
"""


def allow_host(ipaddress):
    subprocess.check_output(
        "sudo iptables -t nat -I CAPTIVE_PASSLIST 1 -s {ip} -j ACCEPT"
        .format(ip=ipaddress), shell=True)


def application(env, start_response):
    if env['REQUEST_URI'] == "/letmein.html":
        allow_host(env['REMOTE_ADDR'])
        start_response('302 Found', [('Location', "http://{{ fqdn }}")])
        return ['1']

    start_response('200 OK', [('Content-Type', 'text/html')])
    return welcome_page
